/*************************************************************************
 > EE569 Homework Assignment #2
 > Date:     February 24, 2017
 > Author:   Chenyu Peng
 > ID:       3498-8893-91
 > email:    chenyupe@usc.edu

 > Compiled on OS X with gcc
 > Input: g++ -o skeletonizing skeletonizing.cpp
 		  ./skeletonizing letterE.raw 480 480
 ************************************************************************/

#include <stdio.h>
#include <iostream>
#include <stdlib.h>
#include <cmath>

using namespace std;

unsigned char skeletonizing[40][8] = {{0,255,0,0,255,0,0,0},{0,255,0,255,0,0,0,0},{0,0,0,255,0,0,255,0},{0,0,0,0,255,0,255,0},                                     //tk_bond4
								{0,0,255,0,255,0,0,255},{255,255,255,0,0,0,0,0},{255,0,0,255,0,255,0,0},{0,0,0,0,0,255,255,255},                                   //stk_bond4
								{255,255,255,0,255,0,0,0},{0,255,255,0,255,0,0,255},{255,255,255,255,0,0,0,0},{255,255,0,255,0,255,0,0},                           //stk_bond6
								{255,0,0,255,0,255,255,0},{0,0,0,255,0,255,255,255},{0,0,0,0,255,255,255,255},{0,0,255,0,255,0,255,255},
								{255,255,255,0,255,0,0,255},{255,255,255,255,0,255,0,0},{255,0,0,255,0,255,255,255},{0,0,255,0,255,255,255,255},                   //stk_bond7
								{0,255,255,0,255,0,255,255},{255,255,255,255,255,0,0,0},{255,255,0,255,0,255,255,0},{0,0,0,255,255,255,255,255},                   //stk_bond8
								{255,255,255,0,255,0,255,255},{0,255,255,0,255,255,255,255},{255,255,255,255,255,255,0,0},{255,255,255,255,255,0,0,255},           //stk_bond9
								{255,255,255,255,0,255,255,0},{255,255,0,255,0,255,255,255},{255,0,0,255,255,255,255,255},{0,0,255,255,255,255,255,255},
								{255,255,255,0,255,255,255,255},{255,255,255,255,255,255,0,255},{255,255,255,255,0,255,255,255},{255,0,255,255,255,255,255,255},   //stk_bond10
								{255,255,255,255,255,0,255,255},{255,255,255,255,255,255,255,0},{255,255,0,255,255,255,255,255},{0,255,255,255,255,255,255,255}};  //k_bond11

unsigned char skeletonizing_uncond[316][8] = {{0,0,0,0,0,0,0,255},{0,0,0,0,0,255,0,0},{0,0,255,0,0,0,0,0},{255,0,0,0,0,0,0,0},                                         //1
											{0,0,0,0,0,0,255,0},{0,0,0,0,255,0,0,0},{0,0,0,255,0,0,0,0},{0,255,0,0,0,0,0,0},                                           //2
											{0,255,0,0,255,0,0,0},{0,255,0,255,0,0,0,0},{0,0,0,0,255,0,255,0},{0,0,0,255,0,0,255,0},                                   //3
											{255,255,0,255,0,0,0,0},{255,255,0,255,0,0,0,255},{255,255,0,255,0,0,255,0},{255,255,0,255,0,0,255,255},                   //4
											{255,255,0,255,0,255,0,0},{255,255,0,255,0,255,0,255},{255,255,0,255,0,255,255,0},{255,255,0,255,0,255,255,255},
											{255,255,0,255,255,0,0,0},{255,255,0,255,255,0,0,255},{255,255,0,255,255,0,255,0},{255,255,0,255,255,0,255,255},
											{255,255,0,255,255,255,0,0},{255,255,0,255,255,255,0,255},{255,255,0,255,255,255,255,0},{255,255,0,255,255,255,255,255},
											{255,255,255,255,0,0,0,0},{255,255,255,255,0,0,0,255},{255,255,255,255,0,0,255,0},{255,255,255,255,0,0,255,255},
											{255,255,255,255,0,255,0,0},{255,255,255,255,0,255,0,255},{255,255,255,255,0,255,255,0},{255,255,255,255,0,255,255,255},
											{255,255,255,255,255,0,0,0},{255,255,255,255,255,0,0,255},{255,255,255,255,255,0,255,0},{255,255,255,255,255,0,255,255},
											{255,255,255,255,255,255,0,0},{255,255,255,255,255,255,0,255},{255,255,255,255,255,255,255,0},{255,255,255,255,255,255,255,255},
											{0,0,0,0,255,0,255,255},{0,0,0,0,255,255,255,255},{0,0,0,255,255,0,255,255},{0,0,0,255,255,255,255,255},
											{0,0,255,0,255,0,255,255},{0,0,255,0,255,255,255,255},{0,0,255,255,255,0,255,255},{0,0,255,255,255,255,255,255},
											{0,255,0,0,255,0,255,255},{0,255,0,0,255,255,255,255},{0,255,0,255,255,0,255,255},{0,255,0,255,255,255,255,255},
											{0,255,255,0,255,0,255,255},{0,255,255,0,255,255,255,255},{0,255,255,255,255,0,255,255},{0,255,255,255,255,255,255,255},
											{255,0,0,0,255,0,255,255},{255,0,0,0,255,255,255,255},{255,0,0,255,255,0,255,255},{255,0,0,255,255,255,255,255},
											{255,0,255,0,255,0,255,255},{255,0,255,0,255,255,255,255},{255,0,255,255,255,0,255,255},{255,0,255,255,255,255,255,255},
											{255,255,0,0,255,0,255,255},{255,255,0,0,255,255,255,255},{255,255,0,255,255,0,255,255},{255,255,0,255,255,255,255,255},
											{255,255,255,0,255,0,255,255},{255,255,255,0,255,255,255,255},{255,255,255,255,255,0,255,255},{255,255,255,255,255,255,255,255},
											{0,255,0,255,255,0,0,0},{0,255,0,255,0,0,255,0},{0,0,0,255,255,0,255,0},{0,255,0,0,255,0,255,0},                           //5
											{0,255,0,255,255,0,0,255},{0,255,0,255,0,0,255,255},{0,0,0,255,255,0,255,255},{0,255,0,0,255,0,255,255},
											{0,255,0,255,255,0,255,0},{0,255,0,255,0,255,255,0},{0,0,0,255,255,255,255,0},{0,255,0,0,255,255,255,0},
											{0,255,0,255,255,0,255,255},{0,255,0,255,0,255,255,255},{0,0,0,255,255,255,255,255},{0,255,0,0,255,255,255,255},
											{0,255,0,255,255,255,0,0},{0,255,0,255,255,0,255,0},{0,0,255,255,255,0,255,0},{0,255,0,255,255,0,255,0},
											{0,255,0,255,255,255,0,255},{0,255,0,255,255,0,255,255},{0,0,255,255,255,0,255,255},{0,255,0,255,255,0,255,255},
											{0,255,0,255,255,255,255,0},{0,255,0,255,255,255,255,0},{0,0,255,255,255,255,255,0},{0,255,0,255,255,255,255,0},
											{0,255,0,255,255,255,255,255},{0,255,0,255,255,255,255,255},{0,0,255,255,255,255,255,255},{0,255,0,255,255,255,255,255},
											{0,255,255,255,255,0,0,0},{0,255,255,255,0,0,255,0},{0,255,0,255,255,0,255,0},{0,255,255,0,255,0,255,0},
											{0,255,255,255,255,0,0,255},{0,255,255,255,0,0,255,255},{0,255,0,255,255,0,255,255},{0,255,255,0,255,0,255,255},
											{0,255,255,255,255,0,255,0},{0,255,255,255,0,255,255,0},{0,255,0,255,255,255,255,0},{0,255,255,0,255,255,255,0},
											{0,255,255,255,255,0,255,255},{0,255,255,255,0,255,255,255},{0,255,0,255,255,255,255,255},{0,255,255,0,255,255,255,255},
											{0,255,255,255,255,255,0,0},{0,255,255,255,255,0,255,0},{0,255,255,255,255,0,255,0},{0,255,255,255,255,0,255,0},
											{0,255,255,255,255,255,0,255},{0,255,255,255,255,0,255,255},{0,255,255,255,255,0,255,255},{0,255,255,255,255,0,255,255},
											{0,255,255,255,255,255,255,0},{0,255,255,255,255,255,255,0},{0,255,255,255,255,255,255,0},{0,255,255,255,255,255,255,0},
											{0,255,255,255,255,255,255,255},{0,255,255,255,255,255,255,255},{0,255,255,255,255,255,255,255},{0,255,255,255,255,255,255,255},
											{255,255,0,255,255,0,0,0},{255,255,0,255,0,0,255,0},{255,0,0,255,255,0,255,0},{255,255,0,0,255,0,255,0},
											{255,255,0,255,255,0,0,255},{255,255,0,255,0,0,255,255},{255,0,0,255,255,0,255,255},{255,255,0,0,255,0,255,255},
											{255,255,0,255,255,0,255,0},{255,255,0,255,0,255,255,0},{255,0,0,255,255,255,255,0},{255,255,0,0,255,255,255,0},
											{255,255,0,255,255,0,255,255},{255,255,0,255,0,255,255,255},{255,0,0,255,255,255,255,255},{255,255,0,0,255,255,255,255},
											{255,255,0,255,255,255,0,0},{255,255,0,255,255,0,255,0},{255,0,255,255,255,0,255,0},{255,255,0,255,255,0,255,0},
											{255,255,0,255,255,255,0,255},{255,255,0,255,255,0,255,255},{255,0,255,255,255,0,255,255},{255,255,0,255,255,0,255,255},
											{255,255,0,255,255,255,255,0},{255,255,0,255,255,255,255,0},{255,0,255,255,255,255,255,0},{255,255,0,255,255,255,255,0},
											{255,255,0,255,255,255,255,255},{255,255,0,255,255,255,255,255},{255,0,255,255,255,255,255,255},{255,255,0,255,255,255,255,255},
											{255,255,255,255,255,0,0,0},{255,255,255,255,0,0,255,0},{255,255,0,255,255,0,255,0},{255,255,255,0,255,0,255,0},
											{255,255,255,255,255,0,0,255},{255,255,255,255,0,0,255,255},{255,255,0,255,255,0,255,255},{255,255,255,0,255,0,255,255},
											{255,255,255,255,255,0,255,0},{255,255,255,255,0,255,255,0},{255,255,0,255,255,255,255,0},{255,255,255,0,255,255,255,0},
											{255,255,255,255,255,0,255,255},{255,255,255,255,0,255,255,255},{255,255,0,255,255,255,255,255},{255,255,255,0,255,255,255,255},
											{255,255,255,255,255,255,0,0},{255,255,255,255,255,0,255,0},{255,255,255,255,255,0,255,0},{255,255,255,255,255,0,255,0},
											{255,255,255,255,255,255,0,255},{255,255,255,255,255,0,255,255},{255,255,255,255,255,0,255,255},{255,255,255,255,255,0,255,255},
											{255,255,255,255,255,255,255,0},{255,255,255,255,255,255,255,0},{255,255,255,255,255,255,255,0},{255,255,255,255,255,255,255,0},
											{255,255,255,255,255,255,255,255},{255,255,255,255,255,255,255,255},{255,255,255,255,255,255,255,255},{255,255,255,255,255,255,255,255},
											{255,0,255,0,0,0,0,255},{255,0,0,0,0,255,0,255},{0,0,255,0,0,255,0,255},{0,0,255,0,0,255,0,255},                           //6
											{255,0,255,0,0,0,255,0},{255,0,0,0,255,255,0,0},{0,255,0,0,0,255,0,255},{0,0,255,255,0,0,0,255},
											{255,0,255,0,0,255,0,0},{255,0,255,0,0,255,0,0},{255,0,0,0,0,255,0,255},{255,0,255,0,0,0,0,255},
											{255,0,255,0,255,0,0,255},{255,0,0,0,0,255,255,255},{0,0,255,0,0,255,255,255},{0,0,255,0,0,255,255,255},
											{255,0,255,0,255,0,255,0},{255,0,0,0,255,255,255,0},{0,255,0,0,0,255,255,255},{0,0,255,255,0,0,255,255},
											{255,0,255,0,255,255,0,0},{255,0,255,0,0,255,255,0},{255,0,0,0,0,255,255,255},{255,0,255,0,0,0,255,255},
											{255,0,255,255,0,0,0,255},{255,0,0,255,0,255,0,255},{0,0,255,0,255,255,0,255},{0,0,255,0,255,255,0,255},
											{255,0,255,255,0,0,255,0},{255,0,0,255,255,255,0,0},{0,255,0,0,255,255,0,255},{0,0,255,255,255,0,0,255},
											{255,0,255,255,0,255,0,0},{255,0,255,255,0,255,0,0},{255,0,0,0,255,255,0,255},{255,0,255,0,255,0,0,255},
											{255,0,255,255,255,0,0,255},{255,0,0,255,0,255,255,255},{0,0,255,0,255,255,255,255},{0,0,255,0,255,255,255,255},
											{255,0,255,255,255,0,255,0},{255,0,0,255,255,255,255,0},{0,255,0,0,255,255,255,255},{0,0,255,255,255,0,255,255},
											{255,0,255,255,255,255,0,0},{255,0,255,255,0,255,255,0},{255,0,0,0,255,255,255,255},{255,0,255,0,255,0,255,255},
											{255,255,255,0,0,0,0,255},{255,255,0,0,0,255,0,255},{0,0,255,255,0,255,0,255},{0,255,255,0,0,255,0,255},
											{255,255,255,0,0,0,255,0},{255,255,0,0,255,255,0,0},{0,255,0,255,0,255,0,255},{0,255,255,255,0,0,0,255},
											{255,255,255,0,0,255,0,0},{255,255,255,0,0,255,0,0},{255,0,0,255,0,255,0,255},{255,255,255,0,0,0,0,255},
											{255,255,255,0,255,0,0,255},{255,255,0,0,0,255,255,255},{0,0,255,255,0,255,255,255},{0,255,255,0,0,255,255,255},
											{255,255,255,0,255,0,255,0},{255,255,0,0,255,255,255,0},{0,255,0,255,0,255,255,255},{0,255,255,255,0,0,255,255},
											{255,255,255,0,255,255,0,0},{255,255,255,0,0,255,255,0},{255,0,0,255,0,255,255,255},{255,255,255,0,0,0,255,255},
											{255,255,255,255,0,0,0,255},{255,255,0,255,0,255,0,255},{0,0,255,255,255,255,0,255},{0,255,255,0,255,255,0,255},
											{255,255,255,255,0,0,255,0},{255,255,0,255,255,255,0,0},{0,255,0,255,255,255,0,255},{0,255,255,255,255,0,0,255},
											{255,255,255,255,0,255,0,0},{255,255,255,255,0,255,0,0},{255,0,0,255,255,255,0,255},{255,255,255,0,255,0,0,255},
											{255,255,255,255,255,0,0,255},{255,255,0,255,0,255,255,255},{0,0,255,255,255,255,255,255},{0,255,255,0,255,255,255,255},
											{255,255,255,255,255,0,255,0},{255,255,0,255,255,255,255,0},{0,255,0,255,255,255,255,255},{0,255,255,255,255,0,255,255},
											{255,255,255,255,255,255,0,0},{255,255,255,255,0,255,255,0},{255,0,0,255,255,255,255,255},{255,255,255,0,255,0,255,255},
											{0,255,0,0,255,255,0,0},{0,255,0,255,0,0,0,255},{0,0,255,255,0,0,255,0},{255,0,0,0,255,0,255,0},                           //7
											{0,255,0,0,255,255,0,255},{0,255,0,255,0,255,0,255},{0,0,255,255,0,0,255,255},{255,0,0,0,255,255,255,0},
											{255,255,0,0,255,255,0,0},{0,255,255,255,0,0,0,255},{255,0,255,255,0,0,255,0},{255,0,255,0,255,0,255,0},
											{255,255,0,0,255,255,0,255},{0,255,255,255,0,255,0,255},{255,0,255,255,0,0,255,255},{255,0,255,0,255,255,255,0}};

int main(int argc, char *argv[])
{
	FILE *file;
	int BytesPerPixel = 1;
	int Length = 0;
	int Width = 0;
	
	if (argc < 4)
	{
		cout << "Syntax Error - Incorrect Parameter Usage:" << endl;
		cout << "program_name input_image.raw Length Width" << endl;
		return 0;
	}
	if (argc >= 4)
	{
		Length = atoi(argv[2]);
		Width = atoi(argv[3]);
	}

	unsigned char Imagedata[Width][Length][BytesPerPixel];

	if (!(file=fopen(argv[1],"rb"))) {
		cout << "Cannot open file: " << argv[1] <<endl;
		exit(1);
	}
	fread(Imagedata, sizeof(unsigned char), Length*Width*BytesPerPixel, file);
	fclose(file);

	unsigned char ImageTrans1[Width+2][Length+2][BytesPerPixel];
	unsigned char ImageTrans2[Width][Length][BytesPerPixel];
	unsigned char ImageTrans3[Width+2][Length+2][BytesPerPixel];
	unsigned char ImageTrans4[Width][Length][BytesPerPixel];

	for(int i=0; i<Width; i++)
		for(int j=0; j<Length; j++)
			for(int k=0; k<BytesPerPixel; k++)
				ImageTrans1[i+1][j+1][k] = Imagedata[i][j][k];

	unsigned char array_temp[8];
	bool break_flag_1 = true;
	bool break_flag_2 = true;
	bool break_flag_3 = false;
	bool break_flag_4 = true;
	bool break_flag_5 = true;

	while(!break_flag_3)
	{
		memset(ImageTrans2,0,sizeof(ImageTrans2));
		for(int i=0; i<Width; i++)
			for(int j=0; j<Length; j++)
				for(int k=0; k<BytesPerPixel; k++)
				{
					if(ImageTrans1[i+1][j+1][k]==255)
					{
						break_flag_2 = true;
						array_temp[0] = ImageTrans1[i][j][k];
						array_temp[1] = ImageTrans1[i][j+1][k];
						array_temp[2] = ImageTrans1[i][j+2][k];
						array_temp[3] = ImageTrans1[i+1][j][k];
						array_temp[4] = ImageTrans1[i+1][j+2][k];
						array_temp[5] = ImageTrans1[i+2][j][k];
						array_temp[6] = ImageTrans1[i+2][j+1][k];
						array_temp[7] = ImageTrans1[i+2][j+2][k];
						for(int a=0; a<40&&break_flag_2; a++)
						{
							break_flag_1 = true;
							for(int b=0; b<8&&break_flag_1; b++)
							{
								if(array_temp[b]!=skeletonizing[a][b])
									break_flag_1 = false;
							}
							if(break_flag_1)
							{
								ImageTrans2[i][j][k] = 255;
								break_flag_2 = false;
							}
							else
								ImageTrans2[i][j][k] = 0;
						}
					}
				}

	for(int i=0; i<Width; i++)
		for(int j=0; j<Length; j++)
			for(int k=0; k<BytesPerPixel; k++)
				ImageTrans3[i+1][j+1][k] = ImageTrans2[i][j][k];

		for(int i=0; i<Width; i++)
			for(int j=0; j<Length; j++)
				for(int k=0; k<BytesPerPixel; k++)
				{
					if(ImageTrans3[i+1][j+1][k]==255)
					{
						break_flag_5 = true;
						array_temp[0] = ImageTrans3[i][j][k];
						array_temp[1] = ImageTrans3[i][j+1][k];
						array_temp[2] = ImageTrans3[i][j+2][k];
						array_temp[3] = ImageTrans3[i+1][j][k];
						array_temp[4] = ImageTrans3[i+1][j+2][k];
						array_temp[5] = ImageTrans3[i+2][j][k];
						array_temp[6] = ImageTrans3[i+2][j+1][k];
						array_temp[7] = ImageTrans3[i+2][j+2][k];
						for(int a=0; a<316&&break_flag_5; a++)
						{
							break_flag_4 = true;
							for(int b=0; b<8&&break_flag_4; b++)
							{
								if(array_temp[b]!=skeletonizing_uncond[a][b])
									break_flag_4 = false;
							}
							if(break_flag_4)
							{
								ImageTrans1[i+1][j+1][k] = 255;
								break_flag_5 = false;
							}
							else
							{
								ImageTrans1[i+1][j+1][k] = 0;
							}
						}
					}
				}

		break_flag_3 = true;
		for(int i=0; i<Width&&break_flag_3; i++)
			for(int j=0; j<Length&&break_flag_3; j++)
				for(int k=0; k<BytesPerPixel; k++)
				{
					if(ImageTrans2[i][j][k]==255)
						break_flag_3 = false;
				}
	}

	for(int i=0; i<Width; i++)
		for(int j=0; j<Length; j++)
			for(int k=0; k<BytesPerPixel; k++)
				ImageTrans4[i][j][k] = ImageTrans1[i+1][j+1][k];

	if (!(file=fopen("letterE_skeletonizing.raw","wb"))) {
		cout << "Cannot open file: " << "letterE_skeletonizing.raw" << endl;
		exit(1);
	}
	fwrite(ImageTrans4, sizeof(unsigned char), Length*Width*BytesPerPixel, file);
	fclose(file);

	return 0;
}
